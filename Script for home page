// Конфигурация
const STEAM_ID = "86745912";
const API_BASE = "https://api.opendota.com/api";
const HERO_IMAGE_BASE = "https://cdn.cloudflare.steamstatic.com";
const ITEM_IMAGE_BASE = "https://cdn.cloudflare.steamstatic.com";

// Элементы DOM
let playerInfo, loading, error, steamIdInput, searchBtn;

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Получаем элементы после загрузки HTML
    playerInfo = document.getElementById('playerInfo');
    loading = document.getElementById('loading');
    error = document.getElementById('error');
    steamIdInput = document.getElementById('steamIdInput');
    searchBtn = document.getElementById('searchBtn');
    
    // Загружаем данные для примера ID при загрузке страницы
    loadPlayerData(STEAM_ID);
    
    // Обработчик кнопки поиска
    if (searchBtn) {
        searchBtn.addEventListener('click', function() {
            const steamId = steamIdInput.value.trim();
            if (steamId) {
                loadPlayerData(steamId);
            } else {
                showError("Пожалуйста, введите Steam ID");
            }
        });
    }
    
    // Обработчик нажатия Enter в поле ввода
    if (steamIdInput) {
        steamIdInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
            }
        });
    }
});

// Основная функция загрузки данных игрока
async function loadPlayerData(steamId) {
    showLoading();
    hideError();
    
    try {
        // 1. Получаем основную информацию об игроке
        const playerResponse = await fetch(`${API_BASE}/players/${steamId}`);
        if (!playerResponse.ok) throw new Error("Игрок не найден");
        const playerData = await playerResponse.json();
        
        // 2. Получаем винрейт и общее количество матчей
        const winLossResponse = await fetch(`${API_BASE}/players/${steamId}/wl`);
        const winLossData = await winLossResponse.json();
        
        // 3. Получаем последние матчи
        const recentMatchesResponse = await fetch(`${API_BASE}/players/${steamId}/recentMatches`);
        const recentMatchesData = await recentMatchesResponse.json();
        
        // 4. Получаем статистику по героям
        const heroesResponse = await fetch(`${API_BASE}/players/${steamId}/heroes`);
        const heroesData = await heroesResponse.json();
        
        // 5. Получаем детали последнего матча
        const lastMatchId = recentMatchesData[0]?.match_id;
        let lastMatchDetails = null;
        if (lastMatchId) {
            const lastMatchResponse = await fetch(`${API_BASE}/matches/${lastMatchId}`);
            lastMatchDetails = await lastMatchResponse.json();
        }
        
        // Отображаем все данные
        displayPlayerInfo(playerData, winLossData);
        displayRecentMatches(recentMatchesData);
        displayTopHeroes(heroesData);
        if (lastMatchDetails) {
            displayLastMatchDetails(lastMatchDetails, steamId);
        }
        
        hideLoading();
        if (playerInfo) playerInfo.style.display = 'block';
        
    } catch (err) {
        hideLoading();
        showError(`Ошибка загрузки данных: ${err.message}. Проверьте Steam ID и попробуйте снова.`);
        console.error(err);
    }
}

// Функция отображения информации об игроке
function displayPlayerInfo(playerData, winLossData) {
    const playerName = document.getElementById('playerName');
    const avatar = document.getElementById('playerAvatar');
    
    if (playerName) playerName.textContent = playerData.profile?.personaname || "Неизвестный игрок";
    
    if (avatar) {
        if (playerData.profile?.avatarfull) {
            avatar.src = playerData.profile.avatarfull;
        } else {
            avatar.src = 'https://via.placeholder.com/120x120/1a1d2b/8a94b3?text=No+Avatar';
        }
    }
    
    // MMR оценка
    const mmrEstimate = document.getElementById('mmrEstimate');
    if (mmrEstimate) {
        const mmr = playerData.mmr_estimate?.estimate || playerData.solo_competitive_rank || "Неизвестно";
        mmrEstimate.textContent = mmr !== "Неизвестно" ? Math.round(mmr) : mmr;
    }
    
    // Винрейт
    const winRateEl = document.getElementById('winRate');
    if (winRateEl) {
        const wins = winLossData.win || 0;
        const losses = winLossData.lose || 0;
        const totalGames = wins + losses;
        const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) + "%" : "Нет данных";
        winRateEl.textContent = winRate;
    }
    
    // Всего матчей
    const totalMatchesEl = document.getElementById('totalMatches');
    if (totalMatchesEl) {
        const wins = winLossData.win || 0;
        const losses = winLossData.lose || 0;
        totalMatchesEl.textContent = wins + losses;
    }
    
    // Ранг
    const rankTierEl = document.getElementById('rankTier');
    if (rankTierEl) {
        const rankTier = playerData.rank_tier ? 
            `Легенда ${playerData.rank_tier % 10}` : 
            (playerData.leaderboard_rank ? `Immortal #${playerData.leaderboard_rank}` : "Неизвестно");
        rankTierEl.textContent = rankTier;
    }
}

// Функция отображения последних матчей
function displayRecentMatches(matches) {
    const container = document.getElementById('recentMatches');
    const countElement = document.getElementById('matchesCount');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    // Ограничиваем 10 матчами
    const recentMatches = matches.slice(0, 10);
    if (countElement) countElement.textContent = `${recentMatches.length} матчей`;
    
    recentMatches.forEach(match => {
        const isWin = match.player_slot < 128 === match.radiant_win;
        const durationMinutes = Math.floor(match.duration / 60);
        const durationSeconds = match.duration % 60;
        
        const matchElement = document.createElement('div');
        matchElement.className = `match-item ${isWin ? '' : 'loss'}`;
        matchElement.innerHTML = `
            <div class="match-hero">
                <img src="${HERO_IMAGE_BASE}/apps/dota2/images/dota_react/heroes/${getHeroName(match.hero_id)}.png" 
                     alt="Hero" class="hero-icon"
                     onerror="this.src='https://via.placeholder.com/50x50/1a1d2b/8a94b3?text=Hero'">
                <div>
                    <div class="hero-name">${getHeroName(match.hero_id).replace('_', ' ')}</div>
                    <div class="match-duration">${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}</div>
                </div>
            </div>
            <div class="match-result ${isWin ? 'win' : 'loss'}">
                ${isWin ? 'ПОБЕДА' : 'ПОРАЖЕНИЕ'}
            </div>
            <div class="kda">
                ${match.kills}/${match.deaths}/${match.assists}
            </div>
        `;
        
        container.appendChild(matchElement);
    });
}

// Функция отображения популярных героев
function displayTopHeroes(heroesData) {
    const container = document.getElementById('topHeroes');
    const countElement = document.getElementById('heroesCount');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    // Сортируем по количеству игр и берем топ-5
    const sortedHeroes = [...heroesData]
        .sort((a, b) => b.games - a.games)
        .slice(0, 5);
    
    if (countElement) countElement.textContent = `${sortedHeroes.length} героев`;
    
    sortedHeroes.forEach(hero => {
        const winRate = ((hero.win / hero.games) * 100).toFixed(1);
        
        const heroElement = document.createElement('div');
        heroElement.className = 'hero-card';
        heroElement.innerHTML = `
            <img src="${HERO_IMAGE_BASE}/apps/dota2/images/dota_react/heroes/${getHeroName(hero.hero_id)}.png" 
                 alt="Hero" class="hero-icon-small"
                 onerror="this.src='https://via.placeholder.com/70x70/1a1d2b/8a94b3?text=Hero'">
            <div class="hero-name">${getHeroName(hero.hero_id).replace('_', ' ')}</div>
            <div class="hero-stats">${hero.games} игр</div>
            <div class="hero-stats"><span class="hero-winrate">${winRate}%</span> побед</div>
        `;
        
        container.appendChild(heroElement);
    });
}

// Функция отображения деталей последнего матча
function displayLastMatchDetails(matchData, steamId) {
    const container = document.getElementById('lastMatchDetails');
    const timeElement = document.getElementById('lastMatchTime');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    // Находим игрока в матче
    const player = matchData.players.find(p => p.account_id.toString() === steamId);
    if (!player) return;
    
    const isWin = player.player_slot < 128 === matchData.radiant_win;
    const durationMinutes = Math.floor(matchData.duration / 60);
    const durationSeconds = matchData.duration % 60;
    
    // Время матча
    const matchTime = new Date(matchData.start_time * 1000);
    const now = new Date();
    const diffHours = Math.floor((now - matchTime) / (1000 * 60 * 60));
    
    let timeText = "";
    if (diffHours < 1) timeText = "Менее часа назад";
    else if (diffHours < 24) timeText = `${diffHours} часов назад`;
    else timeText = `${Math.floor(diffHours / 24)} дней назад`;
    
    if (timeElement) timeElement.textContent = timeText;
    
    // Статистика матча
    const statsHtml = `
        <div class="match-stats">
            <div class="stat-row">
                <span>Результат:</span>
                <span class="${isWin ? 'win' : 'loss'}" style="font-weight: bold;">
                    ${isWin ? 'ПОБЕДА' : 'ПОРАЖЕНИЕ'}
                </span>
            </div>
            <div class="stat-row">
                <span>Длительность:</span>
                <span>${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}</span>
            </div>
            <div class="stat-row">
                <span>K/D/A:</span>
                <span>${player.kills}/${player.deaths}/${player.assists}</span>
            </div>
            <div class="stat-row">
                <span>Урон героям:</span>
                <span>${player.hero_damage || 0}</span>
            </div>
            <div class="stat-row">
                <span>Урон постройкам:</span>
                <span>${player.tower_damage || 0}</span>
            </div>
            <div class="stat-row">
                <span>Золото в минуту (GPM):</span>
                <span>${player.gold_per_min || 0}</span>
            </div>
            <div class="stat-row">
                <span>Опыт в минуту (XPM):</span>
                <span>${player.xp_per_min || 0}</span>
            </div>
        </div>
    `;
    
    // Предметы игрока
    const itemSlots = ['item_0', 'item_1', 'item_2', 'item_3', 'item_4', 'item_5', 'item_neutral'];
    let itemsHtml = '<h4 style="margin-bottom: 15px; color: #f9675a;">Предметы:</h4><div class="items-container">';
    
    itemSlots.forEach(slot => {
        const itemId = player[slot];
        if (itemId && itemId > 0) {
            itemsHtml += `
                <div class="item">
                    <img src="${ITEM_IMAGE_BASE}/apps/dota2/images/dota_react/items/${getItemName(itemId)}.png" 
                         alt="Item"
                         onerror="this.src='https://via.placeholder.com/40x40/1a1d2b/8a94b3?text=Item'">
                </div>
            `;
        } else {
            itemsHtml += '<div class="item" style="background: transparent; border: dashed 1px #2a2f45;"></div>';
        }
    });
    
    itemsHtml += '</div>';
    
    container.innerHTML = statsHtml + itemsHtml;
}

// Вспомогательные функции
function showLoading() {
    if (loading) loading.style.display = 'block';
    if (playerInfo) playerInfo.style.display = 'none';
}

function hideLoading() {
    if (loading) loading.style.display = 'none';
}

function showError(message) {
    if (error) {
        error.textContent = message;
        error.style.display = 'block';
    }
}

function hideError() {
    if (error) error.style.display = 'none';
}

function getHeroName(heroId) {
    const heroMap = {
        1: 'antimage', 2: 'axe', 3: 'bane', 4: 'bloodseeker', 5: 'crystal_maiden',
        6: 'drow_ranger', 7: 'earthshaker', 8: 'juggernaut', 9: 'mirana', 10: 'morphling',
        11: 'nevermore', 12: 'phantom_lancer', 13: 'puck', 14: 'pudge', 15: 'razor',
        16: 'sand_king', 17: 'storm_spirit', 18: 'sven', 19: 'tiny', 20: 'vengefulspirit',
        21: 'windrunner', 22: 'zuus', 23: 'kunkka', 25: 'lina', 26: 'lion',
        27: 'shadow_shaman', 28: 'slardar', 29: 'tidehunter', 30: 'witch_doctor',
        31: 'lich', 32: 'riki', 33: 'enigma', 34: 'tinker', 35: 'sniper',
        36: 'necrolyte', 37: 'warlock', 38: 'beastmaster', 39: 'queenofpain', 40: 'venomancer',
        41: 'faceless_void', 42: 'skeleton_king', 43: 'death_prophet', 44: 'phantom_assassin',
        45: 'pugna', 46: 'templar_assassin', 47: 'viper', 48: 'luna', 49: 'dragon_knight',
        50: 'dazzle', 51: 'rattletrap', 52: 'leshrac', 53: 'furion', 54: 'life_stealer',
        55: 'dark_seer', 56: 'clinkz', 57: 'omniknight', 58: 'enchantress', 59: 'huskar',
        60: 'night_stalker', 61: 'broodmother', 62: 'bounty_hunter', 63: 'weaver', 64: 'jakiro',
        65: 'batrider', 66: 'chen', 67: 'spectre', 68: 'ancient_apparition', 69: 'doom_bringer',
        70: 'ursa', 71: 'spirit_breaker', 72: 'gyrocopter', 73: 'alchemist', 74: 'invoker',
        75: 'silencer', 76: 'obsidian_destroyer', 77: 'lycan', 78: 'brewmaster', 79: 'shadow_demon',
        80: 'lone_druid', 81: 'chaos_knight', 82: 'meepo', 83: 'treant', 84: 'ogre_magi',
        85: 'undying', 86: 'rubick', 87: 'disruptor', 88: 'nyx_assassin', 89: 'naga_siren',
        90: 'keeper_of_the_light', 91: 'wisp', 92: 'visage', 93: 'slark', 94: 'medusa',
        95: 'troll_warlord', 96: 'centaur', 97: 'magnataur', 98: 'shredder', 99: 'bristleback',
        100: 'tusk', 101: 'skywrath_mage', 102: 'abaddon', 103: 'elder_titan', 104: 'legion_commander',
        105: 'techies', 106: 'ember_spirit', 107: 'earth_spirit', 108: 'abyssal_underlord', 109: 'terrorblade',
        110: 'phoenix', 111: 'oracle', 112: 'winter_wyvern', 113: 'arc_warden', 114: 'monkey_king',
        119: 'dark_willow', 120: 'pangolier', 121: 'grimstroke', 123: 'hoodwink', 126: 'void_spirit',
        128: 'snapfire', 129: 'mars', 131: 'dawnbreaker', 135: 'marci', 136: 'primal_beast',
        137: 'muerta'
    };
    return heroMap[heroId] || 'antimage';
}

function getItemName(itemId) {
    const itemMap = {
        1: 'blink', 2: 'blades_of_attack', 3: 'broadsword', 4: 'chainmail', 5: 'claymore',
        6: 'helm_of_iron_will', 7: 'javelin', 8: 'mithril_hammer', 9: 'platemail', 10: 'quarterstaff',
        11: 'quelling_blade', 12: 'ring_of_protection', 13: 'gauntlets', 14: 'slippers', 15: 'mantle',
        16: 'branches', 17: 'belt_of_strength', 18: 'boots_of_elves', 19: 'robe', 20: 'circlet',
        21: 'ogre_axe', 22: 'blade_of_alacrity', 23: 'staff_of_wizardry', 24: 'ultimate_orb',
        25: 'gloves', 26: 'lifesteal', 27: 'ring_of_regen', 28: 'sobi_mask', 29: 'boots',
        30: 'gem', 31: 'cloak', 32: 'talisman_of_evasion', 33: 'cheese', 34: 'magic_stick',
        35: 'recipe_magic_wand', 36: 'magic_wand', 37: 'ghost', 38: 'clarity', 39: 'flask',
        40: 'dust', 41: 'bottle', 42: 'ward_observer', 43: 'ward_sentry', 44: 'tango',
        45: 'courier', 46: 'tpscroll', 47: 'recipe_travel_boots', 48: 'travel_boots', 49: 'recipe_phase_boots',
        50: 'phase_boots', 51: 'demon_edge', 52: 'eagle', 53: 'reaver', 54: 'relic', 55: 'hyperstone',
        56: 'ring_of_health', 57: 'void_stone', 58: 'mystic_staff', 59: 'energy_booster', 60: 'point_booster',
        61: 'vitality_booster', 62: 'recipe_power_treads', 63: 'power_treads', 64: 'recipe_hand_of_midas',
        65: 'hand_of_midas', 66: 'recipe_oblivion_staff', 67: 'oblivion_staff', 68: 'recipe_pers',
        69: 'pers', 70: 'recipe_poor_mans_shield', 71: 'poor_mans_shield', 72: 'recipe_bracer',
        73: 'bracer', 74: 'recipe_wraith_band', 75: 'wraith_band', 76: 'recipe_null_talisman',
        77: 'null_talisman', 78: 'recipe_mekansm', 79: 'mekansm', 80: 'recipe_vladmir',
        81: 'vladmir', 84: 'flying_courier', 85: 'recipe_buckler', 86: 'buckler', 87: 'recipe_ring_of_basilius',
        88: 'ring_of_basilius', 89: 'recipe_pipe', 90: 'pipe', 91: 'recipe_urn_of_shadows',
        92: 'urn_of_shadows', 93: 'recipe_headdress', 94: 'headdress', 95: 'recipe_sheepstick',
        96: 'sheepstick', 97: 'recipe_orchid', 98: 'orchid', 99: 'recipe_cyclone',
        100: 'cyclone', 101: 'recipe_force_staff', 102: 'force_staff', 103: 'recipe_dagon',
        104: 'dagon', 105: 'recipe_necronomicon', 106: 'necronomicon', 107: 'recipe_ultimate_scepter',
        108: 'ultimate_scepter', 109: 'recipe_refresher', 110: 'refresher', 111: 'recipe_assault',
        112: 'assault', 113: 'recipe_heart', 114: 'heart', 115: 'recipe_black_king_bar',
        116: 'black_king_bar', 117: 'aegis', 118: 'recipe_shivas_guard', 119: 'shivas_guard',
        120: 'recipe_bloodstone', 121: 'bloodstone', 122: 'recipe_sphere', 123: 'sphere',
        124: 'recipe_vanguard', 125: 'vanguard', 126: 'recipe_blade_mail', 127: 'blade_mail',
        128: 'recipe_soul_booster', 129: 'soul_booster', 130: 'recipe_hood_of_defiance',
        131: 'hood_of_defiance', 132: 'recipe_rapier', 133: 'rapier', 134: 'recipe_monkey_king_bar',
        135: 'monkey_king_bar', 136: 'recipe_radiance', 137: 'radiance', 138: 'recipe_butterfly',
        139: 'butterfly', 140: 'recipe_greater_crit', 141: 'greater_crit', 142: 'recipe_basher',
        143: 'basher', 144: 'recipe_bfury', 145: 'bfury', 146: 'recipe_manta', 147: 'manta',
        148: 'recipe_lesser_crit', 149: 'lesser_crit', 150: 'recipe_armlet', 151: 'armlet',
        152: 'invis_sword', 153: 'recipe_sange_and_yasha', 154: 'sange_and_yasha', 155: 'recipe_satanic',
        156: 'satanic', 157: 'recipe_mjollnir', 158: 'mjollnir', 159: 'recipe_skadi',
        160: 'skadi', 161: 'recipe_sange', 162: 'sange', 163: 'recipe_helm_of_the_dominator',
        164: 'helm_of_the_dominator', 165: 'recipe_maelstrom', 166: 'maelstrom', 167: 'recipe_desolator',
        168: 'desolator', 169: 'recipe_yasha', 170: 'yasha', 171: 'recipe_mask_of_madness',
        172: 'mask_of_madness', 173: 'recipe_diffusal_blade', 174: 'diffusal_blade', 175: 'recipe_ethereal_blade',
        176: 'ethereal_blade', 177: 'recipe_soul_ring', 178: 'soul_ring', 179: 'recipe_arcane_boots',
        180: 'arcane_boots', 181: 'orb_of_venom', 182: 'stout_shield', 183: 'recipe_invis_sword',
        184: 'recipe_ancient_janggo', 185: 'ancient_janggo', 186: 'recipe_medallion_of_courage',
        187: 'medallion_of_courage', 188: 'smoke_of_deceit', 189: 'recipe_veil_of_discord',
        190: 'veil_of_discord', 191: 'recipe_necronomicon_2', 192: 'recipe_necronomicon_3',
        193: 'necronomicon_2', 194: 'necronomicon_3', 196: 'diffusal_blade_2', 197: 'recipe_dagon_2',
        198: 'recipe_dagon_3', 199: 'recipe_dagon_4', 200: 'recipe_dagon_5', 201: 'dagon_2',
        202: 'dagon_3', 203: 'dagon_4', 204: 'dagon_5', 205: 'recipe_rod_of_atos',
        206: 'rod_of_atos', 207: 'recipe_abyssal_blade', 208: 'abyssal_blade', 209: 'recipe_heavens_halberd',
        210: 'heavens_halberd', 211: 'recipe_ring_of_aquila', 212: 'ring_of_aquila', 213: 'recipe_tranquil_boots',
        214: 'tranquil_boots', 215: 'shadow_amulet', 216: 'enchanted_mango', 217: 'recipe_ward_dispenser',
        218: 'ward_dispenser', 219: 'recipe_travel_boots_2', 220: 'travel_boots_2', 221: 'recipe_lotus_orb',
        222: 'lotus_orb', 223: 'recipe_meteor_hammer', 224: 'meteor_hammer', 225: 'recipe_nullifier',
        226: 'nullifier', 227: 'recipe_spirit_vessel', 228: 'spirit_vessel', 229: 'recipe_hurricane_pike',
        230: 'hurricane_pike', 231: 'recipe_aeon_disk', 232: 'aeon_disk'
    };
    return itemMap[itemId] || 'blink';
}
